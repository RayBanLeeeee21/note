# chapter 19 事务

事务相关命令:
* WATCH key
* MULTI: 开始事务
    * 执行MULTI后只能执行DISCARD或者EXEC, 不能WATCH或者MULTI
* DISCARD: 丢弃事务
* EXEC: 执行


数据结构
- 客户端
    ```cpp
    typedef struct client{
        // ...
        MultiState multiState;
        // ...
    };
    ```
- 事务状态
    - `minreplicas`和`minreplicas_timeout`未找到应用场景, 估计是弃用/未来的功能
    ```cpp
    typedef struct multiState{
        multiCmd* commands;         // 命令队列
        int count;                  // 命令数量
        int minreplicas;            // 最少复制到几个从机后算成功
        time_t minreplicas_timeout; // 等待复制最多等多久
    };
    ```
- 命令
    ```cpp
    typedef struct multiCmd {
        robj **argv;
        int argc;
        struct redisCommand *cmd;
    } multiCmd;
    ```

MULTI实现:
- 执行`MULTI`命令时, 对应`client的REDIS_MULTI位被置位
- 执行`DISCARD`/`EXEC`时, 
* 执行命令时
    ```
    if client.flag & REDIS_MULTI != 0
        if command in {MULTI, WATCH, DISCARD, EXEC}
            直接执行
        else
            命令入队
    ```