# Chapter 01 简单动态字符串

## 数据结构


- 旧版   
    ```c++
    struct sdshdr{
        int len;     // 长度
        int free;    // 空余空间
        char buf[];
    }
    ```
- 新版: 不再是用int作为len & free的类型. len和free的类型有uint8_t, uint16_t, uint32_t, uint64_t共4种类型
    ```c++
    struct __attribute__ ((__packed__)) sdshdr5 {
        unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
        char buf[];
    };
    struct __attribute__ ((__packed__)) sdshdr8 {
        uint8_t len; /* used */
        uint8_t alloc; /* excluding the header and null terminator */
        unsigned char flags; /* 3 lsb of type, 5 unused bits */
        char buf[];
    };
    struct __attribute__ ((__packed__)) sdshdr16 {
        uint16_t len; /* used */
        uint16_t alloc; /* excluding the header and null terminator */
        unsigned char flags; /* 3 lsb of type, 5 unused bits */
        char buf[];
    };
    struct __attribute__ ((__packed__)) sdshdr32 {
        uint32_t len; /* used */
        uint32_t alloc; /* excluding the header and null terminator */
        unsigned char flags; /* 3 lsb of type, 5 unused bits */
        char buf[];
    };
    struct __attribute__ ((__packed__)) sdshdr64 {
        uint64_t len; /* used */
        uint64_t alloc; /* excluding the header and null terminator */
        unsigned char flags; /* 3 lsb of type, 5 unused bits */
        char buf[];
    };
    ```

特点
1. 保存'\0', 但不计入len, 因此可重用一部分的C函数.
2. 保留字符串的长度:
    - 获取长度时, 复杂度为o(1)
    - 修改前判断长度, 不会造成溢出
    - 字符串中可以包含任何字符 (包括'\0') 
3. 减少重分配:
    - 预分配(v2.9): 需要增加空间时
        - 如果新len小于1MB, 预留长度与最新len相等
        - 如果新len大于1MB, 预留长度为1MB
    - 惰性空间释放
4. 对二进制安全: SDS不是以'\0'来判断结尾, 而是存了长度. 因此也可以直接在sds中存字节序列

## 应用场景
- 所有非字面量的字符串
- redis的string类型实现
- AOF缓冲区
- 客户端输入缓冲区


## 所有操作

[所有操作](http://redisdoc.com/string/index.html)(**都是原子操作**)


get & set
- `SET key value [EX seconds] [PX ms] [NX|XX]`
    - EX: 过期时间
    - PX: 过期时间(ms)
    - NX|XX: 不存在|存在时才操作
    - **返回**: 新值
- `GET key`
    - **返回**: 值, 类型不对报错
- `MSET k1 v1 k2 v2 ...`: "Multi-SET"
    - **返回**: 新值组成的列表
- `MGET k1 k2 ...`: "Multi-GET"
    - **返回**: 多个值组成的列表
- `GETSET key value`: 设置新值
    - **返回**: 旧值

修改
- `APPEND key value`: 追加新内容到字符串后
    - **返回**: 新长度
子串
- `SETRANGE key offset value`: 将value覆盖到从offset开始的位置
    - **返回**: 新长度
- `[GETRANGE|SUBSTR] key start end`: **返回**: 范围为`[start, end]`的子串


数字类型
- `[INCR|DECR] key`
    - 为数字类型的值加|减1, 无不存在则默认原来是0, 即新值为1|-1; 原来非数字类型则报错
    - **返回**: 新值
- `[INCRBY|DECRBY] key value`
    - 与INCR|DECR类似, 但可指定增加值

参考:
- 源码: sds.c sds.h
- [Redis深入浅出——字符串和SDS](https://blog.csdn.net/qq193423571/article/details/81637075)
