# Chapter 04 表

## 4.1 索引组织表

索引组织表: 表都是按主键顺序存放

innode主键:
- 创建规则: 
  - 找**首个定义**的**非NULL**&**唯一**索引
    - *匹配到时, _rowid可以作为该字段的别名(多字段索引除外)*
  - 找不到再隐式创建一个6字节的_rowid字段

## 4.2 InnoDB逻辑存储结构


层次:
- 表空间: 单个文件, 包含不同的段
- 段: 每个段由相同类型的页组成
  - 数组段, 回滚段, undo段
- 区: 磁盘空间分配的基本单位
- 页: 缓冲的基本单位

### 4.2.1 表空间

表空间:
- 独立表空间(`innodb_file_per_table=ON`): 可以设置每个表一个表空间
  - 独立表空间
    - 只存放: 数据, 索引, 插入缓冲bitmap. *其它页放在共享表空间*
  - 共享表空间: ibdata1
    - 存放: 系统页, undo页, 事务数据页, 插入缓冲索引等. *以及独立表空间支持的页类型*

### 4.2.3 区

区: 表空间磁盘分配的基本单位
- 单位: 
  - 区: 一个区1MB, 默认64个页
  - 页: 一个页默认16KB, 不过可以设置
    - **碎片页**: 如果表有独立表空间, 则初始分配6个页, 然后在达到32页前分配(即按页分配), 超过后再按区分配


### 4.2.4 页


页类型: (引用P0112, 表4-4)
- 0x45BF: B+树叶结点页 (数据页)
- 0x0000: 新分配页 (未初始)
- 0x0002: Undo Log页
- 0x0003: 索引结点页  (数据页)
- 0x0004: Insert Buffer空闲列表
- 0x0005: Insert Buffer Bitmap (表空间第2页)
- 0x0006: 系统页
- 0x0007: 事务系统数据
- 0x0008: 文件空间头
- 0x0009: 扩展描述页
- 0x000A: BLOB页


## 4.3 InnDB行记录格式 

行记录格式
- Compact
- Redundant

### 4.3.1 Compact行记录格式 

Compact行记录格式
- 变长字段长度列表 (1|2 byte): **逆序**
- NULL标记位 (8 bit): 
- record header(40 bit)
- 列数据

记录头(record header) 
```
deleted_flag    是否被删除
min_rec_flag    是否最小的记录
n_owned         该记录头下面放了几条连着的记录
heap_no         第一条记录的序号(相对整个表)
record_type     记录类型(000: 普通 001: B+树节点指针 010: Infimum 011: Supremum)
next_record     下一条记录的相对位置
```
- Infimum 第一条记录前用来占位的伪记录
- Supremum 最后一条记录后用来占位的伪记录


列数据:
- 隐藏列: 实际数据列前面还有几个隐藏列
  - rowid: 如果没有非空唯一索引, 则自动创建该列
  - trxId: 事务ID
  - rollPointer: 回滚指针
- CHAR填充: 填充空格(0x20)


Q: 怎么知道变长字段长度列表有多少个字段?
// TODO

### 4.3.2 Redundant行记录格式

Redundant行记录格式
- 字段长度偏移列表: **逆序**
- record header(48 bit)
- 列数据


两种格式的主要区别:
- Compact存储CHAR/VARCHAR的NULL不占空间(除了固定的NULL标志位), 而Redundant存储CHAR的NULL占空间


### 4.3.3 行溢出数组

行溢出:
- 对于VARCHAR/BLOB/TEXT类型, 如果一页不能放下两条记录, 则会发生行溢出, 在数组页中只存列数据中768字节的前缀, 剩余部分放到BLOB页, 通过768字节后的指针指向BLOB页

### 4.3.5 CHAR的行结构存储

CHAR(N)中的N指的是字符个数(不是字节), 因此多字节字符的情况下, CHAR与VARCHAR都要保存长度


## 4.4 InnoDB数据页结构 

**(直接看书上的例子)**

InnoDB数据页
| 字段　　　 　       | 描述　　　　　 | 长度    |
|:-------------------|:--------------|:--------|
| File Header        | 页的基本信息　 | 38 byte |
| Page Header        | 数据页专有信息 | 56 byte |
| Infimum + Supremum | 起点和终点记录 |         |
| User Record        | 用户记录　　　 |         |
| Free Space         | 未分配空间　　 |         |
| File Trailer       | 文件尾　　　　 | 8  byte |

File Header(38字节):
- 

## 4.6 约束

域完整性保证
- 数组类型限制
- 外键约束
- 触发器
- Default作为补充

// TODO

## 4.8 分区

扩展话题:
- [彻底搞清分库分表（垂直分库，垂直分表，水平分库，水平分表）](https://blog.csdn.net/weixin_44062339/article/details/100491744)
- [MySQL：互联网公司常用分库分表方案汇总！](https://zhuanlan.zhihu.com/p/137368446)

分区:
- 水平分区: 按行分区
- 垂直分区: 按列分区

局部分区索引 & 全局分区索引
- 局部分区索引: 索引和数据都分在不同分区
- 全局分区索引: 数据分开放, 索引放在一起

mysql提供的分区方式
- RANGE
- LIST
- HASH
- KEY

mysql分区特点:
- 只支持**水平分区**
- 只支持**局部索引分区**
- 当表中存在主键或唯一索引时, 分区列必须是唯一索引的一部分


