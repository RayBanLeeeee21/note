# Chapter 06 锁

MyISAM只支持表锁
Microsoft SQL Server开销很大

innodb锁特性: 
- 行级锁
- 一致性非锁定读(MVCC实现)

## 6.2 lock与latch

innodb中的锁:
|                    |latch                       | lock             |
|:-------------------|:---------------------------|:-----------------|
|持有锁的单元         | 事务                       | 线程              |
|持续时间(锁的范围)   | 整个事务生命周期             | 临界区           |
|形式                | {行锁, 表锁, 意向锁}x{读写锁}| 读写锁, 互斥量    |
|死锁解决            | wait for graph, time out    | 由程序实现保证    |
|保存在              | Lock Manager的哈希表        | 分散在各数据结构中 |

可以通过`show engine innodb mutex`查询

## 6.3 InnoDB引擎中的锁

### 6.3.1 锁的类型

InnoDB的锁
- 多粒度锁
    - 表级
    - 页级
    - 行级
- 互斥类型
    - 共享锁(S, Share)
    - 排他锁(X, eXclusive)
    - 意向锁(IX/IS, Intention)

多粒度意向锁加锁规则:
- 如果要对下级加锁, 则要**自上而下**给所有上级加对应的意向锁
- 互斥规则:
    - X与X互斥, X与S互斥 (X与所有都互斥)
    - IX与IX, IX与IS均不互斥
    - IX与S互斥, IS与X互斥, IS与S不互斥

### 6.3.2 一致性非锁定读

一致性非锁定读:
- 原理: MVCC(多版本并发控制)
    - 实现: 事务会产生undo日志, 可以直接从undo页中拿到之前提交过的版本
- 隔离级别
    - READ UNCOMMITTED: 事务A可以直接读到事务B未提交的数据
    - READ COMMITTED: 事务A总是读到数据最新提交的版本
    - REPEATABLE READ: 事务A总是读到事务A开始之前可以见到的最后一个提交的版本

### 6.3.3 一致性锁定读

共享锁使用方法:
- 排他锁: 
    - `SELECT ... FOR UPDATE`
    - 在事务中使用update
- 共享锁: 
    - `SELECT ... LOCK IN SHARE MODE`

### 6.3.4 自增长与锁

自增长记数器锁: 事务进行插入时, 会对主键产生竞争
- AUTO-INC Locking机制: **特殊表锁**,  完成自增值插入后立即释放, 不用等事务结束
    - 缺点: 还有有所开销

插入类型:
- insert-like
    - simple insert: 在一开始就能确定增长的条数
        - `insert/replace ... where k = v`
    - bulk insert: 一开始不能确定增长的条数
        - `insert/replace ... select ...`: 不确定select的结果
    - mixed mode: 一部分自增, 一部分确定的
        - `insert ... values (NULL, ...), (1, ...)`: 有些主键给了定值, 有些给了NULL
        - `insert ... on duplicate key update`: 不确定是1条还是0条

自增加计数器锁模式(`innodb_autoinc_lock_mode`):
- 0: 所有情况都使用AUTO-INC Locking
- 1: 
    - simple insert使用mutex
    - bulk insert使用AUTO-INC Locking
    - 如果事务中先使用了AUTO-INC Locking, 再做simple insert, 那也要等AUTO-INC Locking释放
- 2: 
    - 所有insert-like都使用mutex, 来一个请求给一个


