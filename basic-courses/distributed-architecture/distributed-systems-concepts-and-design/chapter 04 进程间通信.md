# chapter 04 进程间通信

## 4.1 简介

消息传递抽象: 由UDP的应用程序接口提供
* 面积数据报
双向流抽象: 由TCP的应用程序接口提供
* 面向字节流

## 4.2 互联网协议中的API

消息通信操作:
* send 
* recv

### 4.2.1 进程间通信的特征

通信模型:
* 同步通信:
    * 阻塞send: 阻塞直到消息**被接收**
    * 阻塞recv: 阻塞直到有消息发给自己
* 异步通信
    * 非阻塞send: 只要把消息复制到发送缓冲区即可返回
    * 阻塞/非阻塞recv
        * 非阻塞recv: 调用后即返回, 后台通过 **轮询** 或者 **中断** 来获取缓冲区已满的消息


### 4.2.2 socket

UDP
* 故障模型:
    * 遗漏故障
    * 失序
* 开销:
    * 接收端和发送端保存状态
    * 传输额外的信息
    * 时延

TCP
* **流抽象** 隐藏的细节
    * 消息长度
    * 丢失, 重复
    * 流量控制
    * 失序
    * 消息目的地: 只在建立连接的阶段需要知道消息目的地, 连接建立后不用
* 流通信的相关问题:
    * 数据项匹配: 客户端和服务端要事先协商好数据的格式
    * 阻塞
    * 线程: 服务器接收到连接请求时, 通常会新建一个线程进行通信
* 故障模型
    * **完整性**: 校验和
    * **有效性**: 超时与重传
    * **有序性**: 序号


## 4.3 外部数据表示和编码

外部数据表示:
* CORBA(Common Object Request Broker Architecture): 支持多种语言
* 序列化对象: Java
* XML
* 协议缓冲区
* JSON

### 4.3.4 远程对象引用 

远程对象引用: **远程对象** 的 **唯一标识符**, 在 **整个分布式系统** 中起作用
* 作用:
    * 作为RMI的参数
    * 作为RMI的返回值
* 特点:
    * 确保 **时间唯一性** 和 **空间唯一性**
    * 即使删除后也 **不能被重用**
        * 如果重用, 那调用一个被删除的对象时, 会调用到另一个对象, 而不是被告知对象已被删除.

设计远程对象引用的例子
* IP (32 bit)
* port (32 bit)
* 时间戳 (32 bit)
* 对象编号 (32 bit)
* 远程对象接口

## 4.4 组播通信

组播: 适合 **一对多** 的通信
* 场景:
    * 基于复制服务的容错
    * 服务发现
    * 通过复制数据来获得更好的性能
    * 订阅-通知协议


### 4.4.1 IP组播

IP组播:
* 组的标识: D类IP地址
* 发送方: 接口与UDP类似
* 接收方: 
    * 接收之前要通过组的标识来声明加入某个组

IP数据包在局域网和互联网都可以组播
* 局域网: 利用 **以太网** 等
* 互联网: **组播路由器** 把IP数据包发给接收方所在局域网的路由器, 由该路由器负责在该局域网进行组播
    
临时组分配方法:
* 减小TTL, 以减小作用范围
* 由 **组播地址分配服务器** 来协调临时组的分配, 保证临时组在给定的时间和空间范围中是唯一的

组播的故障模型:
* 通道遗漏故障: 
    * 从一个组播路由器到另一个组播路由器可能会丢失数据报
    * 不是所有成员都能收到组播IP数据报
* 进程遗漏故障: 路由器故障
* 不一定能按序到达

场景:
* 基于复制的容错: 无法用IP组播实现
    * 要求要么所有结点收到消息, 要么都不收到
    * 要求顺序性
* 服务发现: 可以用IP组播实现
    * 允许偶尔的请求丢失
* 利用复制的数据提高性能: 由应用决定
* 事件通知: 由应用决定

## 4.5 网络虚拟化: 覆盖网络
