## 事务
事务的ACID特性
1. 原子性(Atomic): 要么全部操作完成, 要么全都不操作
2. 一致性(Consistency): 在单一事务的情况下, 保持数据库数据的一致
3. 隔离性(Isolation): 一个事务的进行对另一个事务是透明的, 另一事务只能看到它开始前或结束后的状态
4. 持久性(Durability): 一个事务完成提交以后, 就不会因为故障而使完成的操作丢失
*   
    * **事务管理部件**负责**原子性**
    * **用户**负责**一致性**, 以及**补偿事务**
    * **并发控制管理部件**负责**隔离性**
    * **恢复管理部件**负责**持久性**, 以及**事务回滚**

事务状态转移
*   ```
            1       事务开始 (活动状态起点)
                       |       
        executing      |      失败 ---------------
                       |                         |
                       V                         |
            2     最后一条语句 (部分提交状态开始)   |
                    执行完成                      |
                       |                         |
    save information   |      失败 --------------|
                       V                         |
            3       保存成功  (提交状态)          |
                                                 |  
            4       失败状态   <------------------                   
                       |
        roll back      |
                       V
            5       中止状态

           (1) 如果因内部逻辑而失败, 则杀死事务
           (2) 如果因硬件错误而失败, 则重启事务(另一个新事务)        
    ```

## 恢复管理部件
故障类型
* 事务故障
    * 逻辑错误: 非法输入, 无法获取数据, 权限限制等造成事务失败 
    * 系统错误: 系统陷入不良状态(如死锁), 造成事务暂时不能完成
* 系统崩溃: 硬件故障或者系统漏洞
    * 故障-停止假设: 假设非易失存储器的内容完好
* 磁盘故障
    * 解决方法: 备份

基于日志的恢复
* **延迟更新技术**
    * 所有write操作延迟到commit时才执行
    * 执行write之前先保证所有日志已写入稳定存储器
    * 日志中保存新值
    * 故障发生时, 忽略没有commit标签的事务, 对有commit标签的事务进行redo
    * redo是幂等的
* **立即更新技术**
    * 所有write操作立即写入数据库(不一定写入磁盘)
    * 每次write操作之前要保证对应日志已写入稳定存储器
    * 日志中保存新值和旧值
    * 故障发生时
        * 先对无commit标签的事务进行undo
        * 再对有commit标签的事务进行redo
    * redo和undo是幂等的
* **检查点**:
    * 解决日志过多造成搜索日志慢, 恢复时间长的问题
    * 写入检查点的过程 
        1. 将write操作写入日志
        2. 执行write操作
        3. 将checkpoint标签写入日志
    * 故障发生时, 只对最后一个checkpoint以后的日志处理, checkpoint之前的日志可以删除